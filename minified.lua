local a={}a.X,a.Y=term.getSize()a.bigY=a.Y-2;a.startY=4;local b=0;if pocket then b=1;a.nameLen=8;a.infoLen=16;a.items=11 elseif turtle then b=2;a.nameLen=12;a.infoLen=25;a.items=4 else b=3;a.nameLen=16;a.infoLen=32;a.items=10 end;local c={}for d,e in pairs(colors)do c[d]=e;c[e]=d end;for d,e in pairs(colours)do c[d]=e;c[e]=d end;local function f(g,h)term.clear()term.setCursorPos(1,1)print("Grabbing a file that is required to display this page...")print(g,"==>",h)if fs.exists(h)then return end;local i=http.get(g)if i then print("Connected.")local j=i.readAll()i.close()local k=io.open(h,'w')if k then k:write(j):close()print("Complete.")else error("Failed to open "..tostring(h).." for writing.",2)end else error("Failed to connect to "..tostring(g),2)end end;local function l(m,n)m=m or""local o=string.len(m)+1;local p,q=term.getCursorPos()local r=term.getSize()local s=false;local t=-1;local u=false;term.setCursorBlink(true)while true do local v=type(n)=="string"and string.rep(n:sub(1,1),string.len(m))or m;term.setCursorPos(p,q)io.write(string.rep(' ',r-p+1))term.setCursorPos(p,q)local w=o-(r-p+1)if w>=0 then io.write(string.sub(v,w+1))else io.write(v)end;local x=p+o-1;if x>r then x=r end;term.setCursorPos(x,q)if u then local y=term.getBackgroundColor()term.setBackgroundColor(colors.white)io.write(' ')term.setBackgroundColor(y)end;local z={os.pullEvent()}local A=z[1]if A=="char"then local B=z[2]if s then m=string.sub(m,1,o-1)..B..string.sub(m,o+1)else m=string.sub(m,1,o-1)..B..string.sub(m,o)end;o=o+1 elseif A=="key"then local C=z[2]if C==keys.backspace then local D=o-2;if o-2<0 then D=0 end;m=string.sub(m,1,D)..string.sub(m,o)o=o-1;if o<1 then o=1 end elseif C==keys.enter then term.setCursorBlink(false)print()return m elseif C==keys.right then o=o+1;if o>string.len(m)+1 then o=string.len(m)+1 end elseif C==keys.left then o=o-1;if o<1 then o=1 end elseif C==keys.up then o=1 elseif C==keys.down then o=string.len(m)+1 elseif C==keys.delete then m=string.sub(m,1,o-1)..string.sub(m,o+1)elseif C==keys.insert then if s then s=false;term.setCursorBlink(true)os.cancelTimer(t)t=-1;u=false else s=true;term.setCursorBlink(false)t=os.startTimer(0.4)end end elseif A=="timer"then local E=z[2]if E==t then u=not u;t=os.startTimer(0.4)end end end end;local function F(G,H,I,J)if type(G)~=H then error(I.." (expected "..H..", got "..type(G)..")",J and J+1 or 3)end end;local function K(G,H,h,J)if type(G)~="string"then error("Check failure: not string",2)end;if string.len(G)>H then error("Page layout string "..h.." is too long (max: "..tostring(H)..", at: "..tostring(string.len(G))..")",J and J+1 or 3)end end;local function L(M)F(M,"table","Page layout is not a table.")F(M.name,"string","Page: name is of wrong type.")local N="Page "..M.name..": %s is of wrong type."F(M.platform,"string",string.format(N,"platform"))if pocket and M.platform~="pocket"or turtle and M.platform~="turtle"or not pocket and not turtle and(M.platform=="pocket"or M.platform=="turtle")then error("Menu is designed for a different platform ("..M.platform..").",2)end;K(M.name,a.nameLen,"page.name")F(M.info,"string",string.format(N,"info"))K(M.info,a.infoLen,"page.info")F(M.bigInfo,"string",string.format(N,"bigInfo"))term.setCursorPos(1,1)local O=write(M.bigInfo)if O>2 then error("Page "..M.name..": bigInfo is too long and prints too many ".."lines. (Unknown max length)",2)end;F(M.colors,"table",string.format(N,"colors"))F(M.colors.bg,"table",string.format(N,"colors.bg"))local P={"main"}for Q=1,#P do F(M.colors.bg[P[Q]],"string",string.format(N,"colors.bg."..P[Q]))end;F(M.colors.fg,"table",string.format(N,"colors.fg"))P={"error","main","title","info","listInfo","listTitle","bigInfo","selector","arrowDisabled","arrowEnabled","input"}for Q=1,#P do F(M.colors.fg[P[Q]],"string",string.format(N,"colors.fg."..P[Q]))end;if M.selections then for Q=1,#M.selections do local R=M.selections[Q]local S="Page "..M.name..", selection "..tostring(Q)..": %s is of wrong type."local T="page.settings["..tostring(Q).."].%s"F(R.title,"string",string.format(S,"title"))K(R.title,a.nameLen,string.format(T,"title"))F(R.info,"string",string.format(S,"info"))K(R.info,a.infoLen,string.format(T,"info"))F(R.bigInfo,"string",string.format(S,"bigInfo"))term.setCursorPos(1,1)local O=write(R.bigInfo)if O>2 then error("Page "..M.name..", selection "..tostring(Q)..": bigInfo is too long and prints too many ".."lines (Unknown max length).",2)end end else M.selections={}end;if M.settings then for Q=1,#M.settings do local R=M.settings[Q]local S="Page "..M.name..", setting "..tostring(Q)..": %s is of wrong type."local T="page.settings["..tostring(Q).."].%s"F(R.title,"string",string.format(S,"title"))K(R.title,a.nameLen,"title")F(R.bigInfo,"string",string.format(S,"bigInfo"))term.setCursorPos(1,1)local O=write(R.bigInfo)if O>2 then error("Page "..M.name..", setting "..tostring(Q)..": bigInfo is too long and prints too many ".."lines (Unknown max length).",2)end;F(R.setting,"string",string.format(S,"setting"))F(R.tp,"string",string.format(S,"tp"))if R.min then F(R.min,"number",string.format(S,"min"))end;if R.max then F(R.max,"number",string.format(S,"max"))end;if R.tp=="password"then F(R.store,"string",string.format(S,"store"))if R.store~="plain"and R.store~="sha256"and R.store~="sha256salt"and R.store~="kristwallet"then error(string.format("Page %s, setting %d: store is not of allowed ".."values (plain, sha256, sha256salt, kristwallet)",M.name,Q),2)elseif R.store~="plain"then f("https://pastebin.com/raw/6UV4qfNF","/sha256.lua")end end end else M.settings={}end;if M.subPages then for Q=1,#M.subPages do local R=M.subPages[Q]local S="Subpage %d: %s is of wrong type."F(R.name,"string",string.format(S,Q,"name"))F(R.info,"string",string.format(S,Q,"info"))F(R.bigInfo,"string",string.format(S,Q,"bigInfo"))term.setCursorPos(1,1)local O=write(R.bigInfo)if O>2 then error("Page "..M.name..", subpage "..tostring(Q)..": bigInfo is too long and prints too many ".."lines (Unknown max length).",2)end end else M.subPages={}end;term.clear()end;local function U(V,Q)local W=#V.selections;local X=#V.settings;local Y=#V.subPages;if Q>W then if Q>W+X then if Q==W+X+Y+1 then return 1,{title=V.final or"Exit",info="",bigInfo=""}end;if Q>W+X+Y then return 0 end;return 3,V.subPages[Q-W-X]end;return 2,V.settings[Q-W]end;return 1,V.selections[Q]end;local function Z(V)return#V.selections+#V.settings+#V.subPages end;local function _(V,a0,a1)local a2=tostring(settings.get(a0.setting))local r,a3=term.getSize()if a2=="nil"then a2="0"end;while true do term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a4=tonumber(l(a2))if not a4 then term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write("Not a number.")term.setTextColor(a5)os.sleep(2)else local a6=true;if a0.min and a4<a0.min then a6=false;term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write(string.format("Minimum: %d",a0.min))term.setTextColor(a5)a2=tostring(a0.min)end;if a0.max and a4>a0.max then a6=false;term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write(string.format("Maximum: %d",a0.max))term.setTextColor(a5)a2=tostring(a0.max)end;if a6 then return a4 else os.sleep(2)end end end end;local function a7(V,a0,a1)local a2=tostring(c[settings.get(a0.setting)])local r,a3=term.getSize()if a2=="nil"then a2="?"end;while true do term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a4=l(a2)local a8=tonumber(a4)if a8 then if c[a8]then return a8 else term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write("Not a color.")term.setTextColor(a5)os.sleep(2)end else if c[a4]then return c[a4]else term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write("Not a color.")term.setTextColor(a5)os.sleep(2)end end end end;local function a9(V,a0,a1)local r,a3=term.getSize()while true do term.setCursorPos(2,a.startY+a1)io.write(string.rep(' ',r-1))term.setCursorPos(2,a.startY+a1)term.setTextColor(c[V.colors.fg.listTitle])io.write("Password:")term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)term.setTextColor(c[V.colors.fg.input])local aa=l("",'*')term.setCursorPos(2,a.startY+a1)io.write(string.rep(' ',r-1))term.setCursorPos(2,a.startY+a1)term.setTextColor(c[V.colors.fg.listTitle])io.write("Repeat:")term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)term.setTextColor(c[V.colors.fg.input])local ab=l("",'*')if aa==ab then local ac;if a0.store=="sha256"or a0.store=="sha256salt"or a0.store=="kristwallet"then local ad=require(".sha256")if a0.store=="sha256salt"then ac=math.random(1,100000)aa=tostring(ac)..","..aa end;if a0.store=="kristwallet"then aa="KRISTWALLET"..aa end;aa=ad.digest(aa):toHex()if a0.store=="kristwallet"then aa=aa.."-000"end end;return aa,ac else term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write("Not matching!")term.setTextColor(a5)os.sleep(2)end end end;local function ae(V,a0,a1)local r,a3=term.getSize()local af=false;term.setTextColor(c[V.colors.fg.listTitle])term.setCursorPos(2,a.startY+a1)io.write(string.rep(' ',r-1))term.setCursorPos(2,a.startY+a1)io.write("You sure?")while true do term.setCursorPos(a.nameLen+3,a.startY+a1)io.write(string.rep(' ',r-14))term.setCursorPos(a.nameLen+3,a.startY+a1)term.setTextColor(c[V.colors.fg.input])io.write(af and"[ YES ] NO"or"  YES [ NO ]")local z,C=os.pullEvent("key")if C==keys.right or C==keys.left or C==keys.tab then af=not af elseif C==keys.enter then return af end end end;local function ag(V,Q,a1)local r,a3=term.getSize()local ah,a0=U(V,Q)if ah~=2 then error("Dawg something happened!",2)end;term.setCursorPos(a.nameLen+3,a.startY+a1)term.setTextColor(colors[V.colors.fg.input])if a0.tp=="string"then settings.set(a0.setting,l(settings.get(a0.setting)))settings.save(V.settings.location)elseif a0.tp=="number"then local a4=_(V,a0,a1)settings.set(a0.setting,a4)settings.save(V.settings.location)elseif a0.tp=="color"then local a5=a7(V,a0,a1)settings.set(a0.setting,a5)settings.save(V.settings.location)elseif a0.tp=="boolean"then local ai=settings.get(a0.setting)if ai==nil then ai=true else ai=not ai end;settings.set(a0.setting,ai)settings.save(V.settings.location)elseif a0.tp=="password"then if ae(V,a0,a1)then local aa,ac=a9(V,a0,a1)settings.set(a0.setting,aa)if ac then settings.set(a0.setting..".salt",ac)end;settings.save(V.settings.location)end else local a5=term.getTextColor()term.setTextColor(c[V.colors.fg.error])io.write(string.format("Cannot edit type '%s'.",a0.tp))term.setTextColor(a5)os.sleep(2)end end;local function aj(V,ak)local al=1;local am=1;local an=1;local ao={}if not ak then L(V)end;if not V.settings.location then V.settings.location=".settings"end;settings.load(V.settings.location)while true do term.setBackgroundColor(colors[V.colors.bg.main])term.setTextColor(colors[V.colors.fg.title])term.clear()term.setCursorPos(1,1)io.write(V.name)term.setCursorPos(1,2)term.setTextColor(colors[V.colors.fg.info])io.write(V.info)for Q=0,a.items-1 do local ap,R=U(V,an+Q)term.setCursorPos(2,5+Q)if ap==1 then term.setTextColor(colors[V.colors.fg.listTitle])io.write(R.title)term.setCursorPos(a.nameLen+3,5+Q)term.setTextColor(colors[V.colors.fg.listInfo])io.write(R.info)elseif ap==2 then local a0=settings.get(R.setting)if type(a0)=="string"and string.len(a0)>a.infoLen then a0=a0:sub(1,a.infoLen-3)a0=a0 .."..."end;term.setTextColor(colors[V.colors.fg.listTitle])io.write(R.title)term.setCursorPos(a.nameLen+3,5+Q)term.setTextColor(colors[V.colors.fg.listInfo])if R.tp=="string"or R.tp=="number"then io.write(a0 or"Error: empty")elseif R.tp=="boolean"then if a0==true then io.write("  false [ true ]")elseif a0==false then io.write("[ false ] true")else io.write("? false ? true ?")end elseif R.tp=="color"then io.write(a0 and string.format("%s (%d)",c[a0],a0)or"? (nil)")elseif R.tp=="password"then local aq={plain="Plaintext",sha256="sha256",sha256salt="sha256 + salt",kristwallet="Kristwallet"}if pocket then io.write(a0 and aq[R.store]or"Not yet set")else io.write(a0 and"Stored as "..aq[R.store]or"Not yet set")end else io.write(pocket and"Unsupported"or"Unsupported type.")end elseif ap==3 then term.setTextColor(colors[V.colors.fg.listTitle])io.write(R.name)term.setTextColor(colors[V.colors.fg.listInfo])term.setCursorPos(a.nameLen+3,5+Q)io.write(R.info)elseif ap~=0 then io.write("Broken.")end end;local ar,as=U(V,al)term.setTextColor(colors[V.colors.fg.bigInfo])term.setCursorPos(1,a.Y-2)io.write(as.bigInfo)term.setCursorPos(1,a.startY+am)term.setTextColor(colors[V.colors.fg.selector])io.write(">")term.setCursorPos(1,a.startY+a.items+1)if an+a.items>Z(V)+1 then term.setTextColor(colors[V.colors.fg.arrowDisabled])else term.setTextColor(colors[V.colors.fg.arrowEnabled])end;io.write(string.char(31))term.setCursorPos(1,a.startY)if an>1 then term.setTextColor(colors[V.colors.fg.arrowEnabled])else term.setTextColor(colors[V.colors.fg.arrowDisabled])end;io.write(string.char(30))local z,C=os.pullEvent("key")if C==keys.up then al=al-1;if am==1 then an=an-1 end;if an<1 then an=1 end;am=am-1;if am<1 then am=1 end;if al<1 then al=Z(V)+1;am=Z(V)+1<a.items and Z(V)+1 or a.items;an=al-a.items+1;if an<1 then an=1 end end elseif C==keys.down then al=al+1;if am==a.items then an=an+1 end;am=am+1;if am>a.items then am=a.items end;if al>Z(V)+1 then al=1;an=1;am=1 end elseif C==keys.enter then if ar==1 then return al elseif ar==2 then ag(V,al,am)elseif ar==3 then local Q,R=U(V,al)if not R.colors then R.colors=V.colors end;if not R.platform then R.platform=V.platform end;if not R.settings then R.settings={location=V.settings.location}end;if not R.settings.location then R.settings.location=V.settings.location end;aj(R,ak)end end end;printError("This shouldn't happen.")printError("Please report to le github with your layout file.")os.sleep(30)end;return aj
