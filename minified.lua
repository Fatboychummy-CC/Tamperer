local a={}a.X,a.Y=term.getSize()a.bigY=a.Y-2;a.startY=4;local b=0;if pocket then b=1;a.nameLen=8;a.infoLen=16;a.items=11 elseif turtle then b=2;a.nameLen=12;a.infoLen=25;a.items=4 else b=3;a.nameLen=16;a.infoLen=32;a.items=10 end;local c={}for d,e in pairs(colors)do c[d]=e;c[e]=d end;for d,e in pairs(colours)do c[d]=e;c[e]=d end;local f={name="string",info="string",bigInfo="string",platform="string.choices(all,turtle,pocket,computer)",colors={["!"]=false,bg={main="color"},fg={main="color",title="color",info="color",listInfo="color",listTitle="color",bigInfo="color",selector="color",arrowDisabled="color",arrowEnabled="color",input="color",error="color"}},selections={["!"]=true,["?"]={title="string",info="string",bigInfo="string"}},settings={["!"]=true,location="string",["?"]={setting="string",title="string",tp="string.choices(string,number,color,password,boolean)",bigInfo="string",min="nil/number.depends(tp=string(number))",max="nil/number.depends(tp=string(number))",store="nil/string.depends(tp=string(password)).choices(plain,sha256,sha256salt,kristwallet)"}},final="nil/string"}f.subPages={["!"]=true,["?"]=f}local function g(h,i)term.clear()term.setCursorPos(1,1)print("Grabbing a file that is required to display this page...")print(h,"==>",i)if fs.exists(i)then return end;local j=http.get(h)if j then print("Connected.")local k=j.readAll()j.close()local l=io.open(i,'w')if l then l:write(k):close()print("Complete.")else error("Failed to open "..tostring(i).." for writing.",2)end else error("Failed to connect to "..tostring(h),2)end end;local function m(n,o)n=n or""local p=string.len(n)+1;local q,r=term.getCursorPos()local s=term.getSize()local t=false;local u=-1;local v=false;term.setCursorBlink(true)while true do local w=type(o)=="string"and string.rep(o:sub(1,1),string.len(n))or n;term.setCursorPos(q,r)io.write(string.rep(' ',s-q+1))term.setCursorPos(q,r)local x=p-(s-q+1)if x>=0 then io.write(string.sub(w,x+1))else io.write(w)end;local y=q+p-1;if y>s then y=s end;term.setCursorPos(y,r)if v then local z=term.getBackgroundColor()term.setBackgroundColor(colors.white)io.write(' ')term.setBackgroundColor(z)end;local A={os.pullEvent()}local B=A[1]if B=="char"then local C=A[2]if t then n=string.sub(n,1,p-1)..C..string.sub(n,p+1)else n=string.sub(n,1,p-1)..C..string.sub(n,p)end;p=p+1 elseif B=="key"then local D=A[2]if D==keys.backspace then local E=p-2;if p-2<0 then E=0 end;n=string.sub(n,1,E)..string.sub(n,p)p=p-1;if p<1 then p=1 end elseif D==keys.enter then term.setCursorBlink(false)print()return n elseif D==keys.right then p=p+1;if p>string.len(n)+1 then p=string.len(n)+1 end elseif D==keys.left then p=p-1;if p<1 then p=1 end elseif D==keys.up then p=1 elseif D==keys.down then p=string.len(n)+1 elseif D==keys.delete then n=string.sub(n,1,p-1)..string.sub(n,p+1)elseif D==keys.insert then if t then t=false;term.setCursorBlink(true)os.cancelTimer(u)u=-1;v=false else t=true;term.setCursorBlink(false)u=os.startTimer(0.4)end end elseif B=="timer"then local F=A[2]if F==u then v=not v;u=os.startTimer(0.4)end end end end;local function G(H)local I="[^/]+"local J="%.depends%((.+)=(.+)%((.+)%)%)"local K="%.choices%((.-)%)"local L="[^,]+"local function M(i,D,N,O)return string.format("Section '%s': '%s': Expected '%s', got '%s'.",i,D,type(N)=="string"and N or table.concat(N,"/"),O)end;local function P(Q,i,R)if type(Q)~="table"then error("AAAA")end;if i==nil then error(M("unknown","name","string","nil"),0)end;for d,e in pairs(R or f)do if d=="?"then for S=1,#Q do P(Q[S],string.format("%s[%d]",i,S),e)end elseif d=="!"then elseif type(e)=="table"then if type(Q[d])~="table"and type(e["!"])~="boolean"then error(M(i,d,"table",type(Q[d])))elseif type(e["!"])=="boolean"and not e["!"]and R then elseif type(Q[d])=="table"then P(Q[d],i.."."..tostring(d),e)else Q[d]={}end else local N={}for T in e:gmatch(I)do N[#N+1]=T end;local U=false;for S=1,#N do local V=N[S]local W,X,Y=V:match(J)local Z=V:match(K)local _=false;local a0=V:find("%.")local a1=V;if a0 then a1=V:sub(1,a0-1)end;if type(Q[d])==a1 then _=true end;local a2=false;if W then if X=="number"then Y=tonumber(Y)elseif X=="password"then error(string.format("Section '%s': '%s': Cannot depend on password!",i,d))end;if Q[W]and type(Q[W])==X and Q[W]==Y then a2=true end else a2=true end;local a3=false;if Z then local a4={}for T in Z:gmatch(L)do a4[#a4+1]=T end;for S=1,#a4 do if a1=="number"then a4[S]=tonumber(a4[S])end;if a4[S]==Q[d]then a3=true;break end end else a3=true end;if a2 and a3 and _ then U=true;break end;if _ and not a2 then error(string.format("Section '%s': '%s': Dependency not met ('%s' must be of type '%s', and with value '%s').",i,d,W,X,Y))end;if _ and not a3 then error(string.format("Section '%s': '%s': Choices allowed: %s (got '%s').",i,d,Z,Q[d]))end end;if not U then error(string.format("Section '%s': '%s': Expected '%s', got '%s'.",i,d,e,type(Q[d])))end end end end;P(H,H.name)term.clear()end;local function a5(a6,S)local a7=#a6.selections;local a8=#a6.settings;local a9=#a6.subPages;if S>a7 then if S>a7+a8 then if S==a7+a8+a9+1 then return 1,{title=a6.final or"Exit",info="",bigInfo=""}end;if S>a7+a8+a9 then return 0 end;return 3,a6.subPages[S-a7-a8]end;return 2,a6.settings[S-a7]end;return 1,a6.selections[S]end;local function aa(a6)return#a6.selections+#a6.settings+#a6.subPages end;local function ab(a6,ac,ad)local ae=tostring(settings.get(ac.setting))local s,af=term.getSize()if ae=="nil"then ae="0"end;while true do term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ag=tonumber(m(ae))if not ag then term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write("Not a number.")term.setTextColor(ah)os.sleep(2)else local U=true;if ac.min and ag<ac.min then U=false;term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write(string.format("Minimum: %d",ac.min))term.setTextColor(ah)ae=tostring(ac.min)end;if ac.max and ag>ac.max then U=false;term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write(string.format("Maximum: %d",ac.max))term.setTextColor(ah)ae=tostring(ac.max)end;if U then return ag else os.sleep(2)end end end end;local function ai(a6,ac,ad)local ae=tostring(c[settings.get(ac.setting)])local s,af=term.getSize()if ae=="nil"then ae="?"end;while true do term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ag=m(ae)local aj=tonumber(ag)if aj then if c[aj]then return aj else term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write("Not a color.")term.setTextColor(ah)os.sleep(2)end else if c[ag]then return c[ag]else term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write("Not a color.")term.setTextColor(ah)os.sleep(2)end end end end;local function ak(a6,ac,ad)local s,af=term.getSize()while true do term.setCursorPos(2,a.startY+ad)io.write(string.rep(' ',s-1))term.setCursorPos(2,a.startY+ad)term.setTextColor(c[a6.colors.fg.listTitle])io.write("Password:")term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)term.setTextColor(c[a6.colors.fg.input])local al=m("",'*')term.setCursorPos(2,a.startY+ad)io.write(string.rep(' ',s-1))term.setCursorPos(2,a.startY+ad)term.setTextColor(c[a6.colors.fg.listTitle])io.write("Repeat:")term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)term.setTextColor(c[a6.colors.fg.input])local am=m("",'*')if al==am then local an;if ac.store=="sha256"or ac.store=="sha256salt"or ac.store=="kristwallet"then local ao=require(".sha256")if ac.store=="sha256salt"then an=math.random(1,100000)al=tostring(an)..","..al end;if ac.store=="kristwallet"then al="KRISTWALLET"..al end;al=ao.digest(al):toHex()if ac.store=="kristwallet"then al=al.."-000"end end;return al,an else term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write("Not matching!")term.setTextColor(ah)os.sleep(2)end end end;local function ap(a6,ac,ad)local s,af=term.getSize()local aq=false;term.setTextColor(c[a6.colors.fg.listTitle])term.setCursorPos(2,a.startY+ad)io.write(string.rep(' ',s-1))term.setCursorPos(2,a.startY+ad)io.write("You sure?")while true do term.setCursorPos(a.nameLen+3,a.startY+ad)io.write(string.rep(' ',s-14))term.setCursorPos(a.nameLen+3,a.startY+ad)term.setTextColor(c[a6.colors.fg.input])io.write(aq and"[ YES ] NO"or"  YES [ NO ]")local A,D=os.pullEvent("key")if D==keys.right or D==keys.left or D==keys.tab then aq=not aq elseif D==keys.enter then return aq end end end;local function ar(a6,S,ad)local s,af=term.getSize()local a1,ac=a5(a6,S)if a1~=2 then error("Dawg something happened!",2)end;term.setCursorPos(a.nameLen+3,a.startY+ad)term.setTextColor(colors[a6.colors.fg.input])if ac.tp=="string"then settings.set(ac.setting,m(settings.get(ac.setting)))settings.save(a6.settings.location)elseif ac.tp=="number"then local ag=ab(a6,ac,ad)settings.set(ac.setting,ag)settings.save(a6.settings.location)elseif ac.tp=="color"then local ah=ai(a6,ac,ad)settings.set(ac.setting,ah)settings.save(a6.settings.location)elseif ac.tp=="boolean"then local as=settings.get(ac.setting)if as==nil then as=true else as=not as end;settings.set(ac.setting,as)settings.save(a6.settings.location)elseif ac.tp=="password"then if ap(a6,ac,ad)then local al,an=ak(a6,ac,ad)settings.set(ac.setting,al)if an then settings.set(ac.setting..".salt",an)end;settings.save(a6.settings.location)end else local ah=term.getTextColor()term.setTextColor(c[a6.colors.fg.error])io.write(string.format("Cannot edit type '%s'.",ac.tp))term.setTextColor(ah)os.sleep(2)end end;local function at(a6,au)local av=1;local aw=1;local ax=1;local ay={}if not au then G(a6)end;if not a6.settings.location then a6.settings.location=".settings"end;settings.load(a6.settings.location)while true do term.setBackgroundColor(colors[a6.colors.bg.main])term.setTextColor(colors[a6.colors.fg.title])term.clear()term.setCursorPos(1,1)io.write(a6.name)term.setCursorPos(1,2)term.setTextColor(colors[a6.colors.fg.info])io.write(a6.info)for S=0,a.items-1 do local az,aA=a5(a6,ax+S)term.setCursorPos(2,5+S)if az==1 then term.setTextColor(colors[a6.colors.fg.listTitle])io.write(aA.title)term.setCursorPos(a.nameLen+3,5+S)term.setTextColor(colors[a6.colors.fg.listInfo])io.write(aA.info)elseif az==2 then local ac=settings.get(aA.setting)if type(ac)=="string"and string.len(ac)>a.infoLen then ac=ac:sub(1,a.infoLen-3)ac=ac.."..."end;term.setTextColor(colors[a6.colors.fg.listTitle])io.write(aA.title)term.setCursorPos(a.nameLen+3,5+S)term.setTextColor(colors[a6.colors.fg.listInfo])if aA.tp=="string"or aA.tp=="number"then io.write(ac or"Error: empty")elseif aA.tp=="boolean"then if ac==true then io.write("  false [ true ]")elseif ac==false then io.write("[ false ] true")else io.write("? false ? true ?")end elseif aA.tp=="color"then io.write(ac and string.format("%s (%d)",c[ac],ac)or"? (nil)")elseif aA.tp=="password"then local aB={plain="Plaintext",sha256="sha256",sha256salt="sha256 + salt",kristwallet="Kristwallet"}if pocket then io.write(ac and aB[aA.store]or"Not yet set")else io.write(ac and"Stored as "..aB[aA.store]or"Not yet set")end else io.write(pocket and"Unsupported"or"Unsupported type.")end elseif az==3 then term.setTextColor(colors[a6.colors.fg.listTitle])io.write(aA.name)term.setTextColor(colors[a6.colors.fg.listInfo])term.setCursorPos(a.nameLen+3,5+S)io.write(aA.info)elseif az~=0 then io.write("Broken.")end end;local aC,aD=a5(a6,av)term.setTextColor(colors[a6.colors.fg.bigInfo])term.setCursorPos(1,a.Y-2)io.write(aD.bigInfo)term.setCursorPos(1,a.startY+aw)term.setTextColor(colors[a6.colors.fg.selector])io.write(">")term.setCursorPos(1,a.startY+a.items+1)if ax+a.items>aa(a6)+1 then term.setTextColor(colors[a6.colors.fg.arrowDisabled])else term.setTextColor(colors[a6.colors.fg.arrowEnabled])end;io.write(string.char(31))term.setCursorPos(1,a.startY)if ax>1 then term.setTextColor(colors[a6.colors.fg.arrowEnabled])else term.setTextColor(colors[a6.colors.fg.arrowDisabled])end;io.write(string.char(30))local A,D=os.pullEvent("key")if D==keys.up then av=av-1;if aw==1 then ax=ax-1 end;if ax<1 then ax=1 end;aw=aw-1;if aw<1 then aw=1 end;if av<1 then av=aa(a6)+1;aw=aa(a6)+1<a.items and aa(a6)+1 or a.items;ax=av-a.items+1;if ax<1 then ax=1 end end elseif D==keys.down then av=av+1;if aw==a.items then ax=ax+1 end;aw=aw+1;if aw>a.items then aw=a.items end;if av>aa(a6)+1 then av=1;ax=1;aw=1 end elseif D==keys.enter then if aC==1 then return av elseif aC==2 then ar(a6,av,aw)elseif aC==3 then local S,aA=a5(a6,av)if not aA.colors then aA.colors=a6.colors end;if not aA.platform then aA.platform=a6.platform end;if not aA.settings then aA.settings={location=a6.settings.location}end;if not aA.settings.location then aA.settings.location=a6.settings.location end;at(aA,au)end end end;printError("This shouldn't happen.")printError("Please report to le github with your layout file.")os.sleep(30)end;local function aE(aF)local j=io.open(aF,'r')if j then local aG=j:read("*a")j:close()local a6,aH=load("return "..tostring(aG),aF)if not a6 then error(aH,2)end;at(a6())else error(string.format("No file '%s'.",aF),2)end end;return{display=at,displayFile=aE}
